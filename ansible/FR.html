<!DOCTYPE html>
<html lang=FR>
    <head>
        <title> ansible Refcard</title>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
        <link rel='stylesheet' href='../css/refcards-style.css'>
        <script async defer src="https://buttons.github.io/buttons.js"></script>
    </head>
    <body>
    <div class="first-page" style="background-color: #2e4995">
        <div class="buttons">
            <a href="../index.html">
                <img src="../assets/back-logo.svg" alt="fleche retour">
            </a>
            <a href="https://github.com/ineat/refcards/discussions/new" class="hide_mobile">Une erreur ? Une question ? Éditer cette page sur Github</a>
            <a class="github-button" href="https://github.com/ineat/refcards" data-color-scheme="no-preference: light; light: light; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star ineat/refcards on GitHub">Star</a>
        </div>
        <img src="" alt="">
        <div class="band">
            <img src="assets/logo-ansible.png" alt="logo ansible">
            <img src="../assets/ineat-logo.svg" alt="logo ineat">
        </div>
        <a href="https://github.com/ineat/refcards">
            <img src="../assets/github_fabbutton.svg" alt="logo github" id="github">
        </a>
    </div>
    <div class="buttons-on-page">
        <a href="../index.html">
            <img src="../assets/back-logo-black.svg" alt="fleche retour">
        </a>
        <a href="https://github.com/ineat/refcards/discussions/new" class="hide_mobile">Une erreur ? Une question ? Éditer cette page sur Github</a>
        <a class="github-button" href="https://github.com/ineat/refcards" data-color-scheme="no-preference: light; light: light; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star ineat/refcards on GitHub">Star</a>
    </div>
        <h1 class="heading1" style="color: #2e4995" id="ansible-refcard"><a class="anchor" href="#ansible-refcard"><img src="../assets/anchor.svg" alt></a>Ansible RefCard</h1><p><em>Version française</em></p>
<p>RefCard d&#39;utilisation de Ansible.</p>
<p>Ecrit par Germain LEFEBVRE en December 2018 pour Ansible v2.7.</p>
<p><strong>Sommaire</strong></p>
<ol>
<li><a class="links" style="color :#2e4995" href="#context" title="">Contexte</a></li>
<li><a class="links" style="color :#2e4995" href="#version-ansible-à-jour" title="">Version Ansible à jour</a></li>
<li><a class="links" style="color :#2e4995" href="#définitions-des-objets" title="">Définitions des objets</a></li>
<li><a class="links" style="color :#2e4995" href="#configuration-de-ansible" title="">Configuration de Ansible</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-adhoc-commands" title="">Commandes AdHoc</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-inventories" title="">Ansible Inventories</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-tasks" title="">Ansible Tasks</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-playbooks" title="">Ansible Playbooks</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-variables" title="">Ansible Variables</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-plays" title="">Ansible Plays</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-roles" title="">Ansible Roles</a></li>
<li><a class="links" style="color :#2e4995" href="#import-de-playbooks-tasks-et-roles" title="">Import de Playbooks, Tasks et Roles</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-options" title="">Ansible Options</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-modules" title="">Ansible Modules</a></li>
<li><a class="links" style="color :#2e4995" href="#ansible-vault" title="">Ansible Vault</a></li>
<li><a class="links" style="color :#2e4995" href="#extension-par-utilisation" title="">Extension par utilisation</a></li>
</ol>
<h3 class="heading3" style="color: #2e4995" id="context"><a class="anchor" href="#context"><img src="../assets/anchor.svg" alt></a>Context</h3><p>Voici la liste des versions des paquets utilisés pour réaliser la RefCard.</p>
<p>Distribution et version :</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">cat /etc/redhat-release</code></pre><pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">CentOS Linux release 7.5.1804 (Core)</code></pre><p>Version Python:</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">python --version</code></pre><pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">Python 2.7.5</code></pre><p>Version Ansible:</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible --version</code></pre><pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible 2.7.1
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u&#x27;/home/ansible/.ansible/plugins/modules&#x27;, u&#x27;/usr/share/ansible/plugins/modules&#x27;]
  ansible python module location = /usr/lib/python2.7/site-packages/ansible
  executable location = /bin/ansible
  python version = 2.7.5 (default, Apr 11 2018, 07:36:10) [GCC 4.8.5 20150623 (Red Hat 4.8.5-28)]</code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="version-ansible-à-jour"><a class="anchor" href="#version-ansible-à-jour"><img src="../assets/anchor.svg" alt></a>Version Ansible à jour</h2><p>Ansible dévoile sa Roadmap pour la v2.7 : <a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/roadmap/ROADMAP_2_7.html" title="">https://docs.ansible.com/ansible/2.7/roadmap/ROADMAP_2_7.html</a></p>
<p>Ansible met à disposition des guides de portage pour aider à rester à jour :</p>
<ul>
<li><a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/porting_guides/porting_guide_2.0.html" title="">Ansible 2.0 Porting Guide</a></li>
<li><a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/porting_guides/porting_guide_2.3.html" title="">Ansible 2.3 Porting Guide</a></li>
<li><a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/porting_guides/porting_guide_2.4.html" title="">Ansible 2.4 Porting Guide</a></li>
<li><a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/porting_guides/porting_guide_2.5.html" title="">Ansible 2.5 Porting Guide</a></li>
<li><a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/porting_guides/porting_guide_2.6.html" title="">Ansible 2.6 Porting Guide</a></li>
<li><a class="links" style="color :#2e4995" href="https://docs.ansible.com/ansible/2.7/porting_guides/porting_guide_2.7.html" title="">Ansible 2.7 Porting Guide</a></li>
</ul>
</div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="définitions-des-objets"><a class="anchor" href="#définitions-des-objets"><img src="../assets/anchor.svg" alt></a>Définitions des objets</h2><h3 class="heading3" style="color: #2e4995" id="facts"><a class="anchor" href="#facts"><img src="../assets/anchor.svg" alt></a>Facts</h3><p>Les Facts sont des variables utilisées par Ansible pour persister des données entre les machines et leurs exécutions au sein d&#39;une séquence d&#39;un playbook. Chaque machine possède ses propres facts, comportant des données sur le système. Il est également possible d&#39;injecter des facts.</p>
<h3 class="heading3" style="color: #2e4995" id="hosts"><a class="anchor" href="#hosts"><img src="../assets/anchor.svg" alt></a>Hosts</h3><p>Les Hosts sont les serveurs joignables par le Master Ansible sur lesquels sont appliquées les actions.</p>
<h3 class="heading3" style="color: #2e4995" id="inventories"><a class="anchor" href="#inventories"><img src="../assets/anchor.svg" alt></a>Inventories</h3><p>Les Inventories comportent la liste des serveurs identifiés par IP/FQDN et organisés dans des groupes. Les groupes peuvent être constitués de serveurs ou de groupes de serveurs. Les serveurs peuvent être aliasés pour faciliter la lisibilité globale.</p>
<h3 class="heading3" style="color: #2e4995" id="tasks"><a class="anchor" href="#tasks"><img src="../assets/anchor.svg" alt></a>Tasks</h3><p>Les Tasks sont des actions exécutées sur les serveurs distants. Les tâches sont écrites en YAML. La structure descriptive des actions permet de faciliter la lecture, d&#39;unifier et d&#39;homogénéiser l&#39;écriture.</p>
<h3 class="heading3" style="color: #2e4995" id="variables"><a class="anchor" href="#variables"><img src="../assets/anchor.svg" alt></a>Variables</h3><p>Les Variables apportent la possibilité de modifier les valeurs au sein des tâches. Elles puevent avoir une portée locale à une séquence ou une portée globale à tous les playbooks.</p>
<h3 class="heading3" style="color: #2e4995" id="plays"><a class="anchor" href="#plays"><img src="../assets/anchor.svg" alt></a>Plays</h3><p>Les Plays sont des séquences d&#39;actions, comportent des tâches et des inventaires. Ils permettent d&#39;appliquer une liste de tâches sur un ensemble de serveurs.</p>
<h3 class="heading3" style="color: #2e4995" id="playbooks"><a class="anchor" href="#playbooks"><img src="../assets/anchor.svg" alt></a>Playbooks</h3><p>Les Playbooks regroupent des ensembles de Plays pour arriver à un but. Les Playbooks sont des fichiers lancés avec la commande ansible-playbook.</p>
<h3 class="heading3" style="color: #2e4995" id="roles"><a class="anchor" href="#roles"><img src="../assets/anchor.svg" alt></a>Roles</h3><p>Les Roles sont des regroupements de tâches servant dans un même but. Ils sont appelés par les playbooks et permettent une meilleure lisibilité et facilité d&#39;écriture. Les Roles ont pour vocation de devenir génériques, réutilisables et personnalisables grace aux variables.</p>
<h3 class="heading3" style="color: #2e4995" id="handlers"><a class="anchor" href="#handlers"><img src="../assets/anchor.svg" alt></a>Handlers</h3><p>Les Handlers sont des actions appelées lorsqu&#39;elles sont déclenchées par des tâches. Le déclenchement se fait à l&#39;exécution d&#39;une tâche, mais son exécution s&#39;effectue à la fin de la séquence d&#39;actions.</p>
<h3 class="heading3" style="color: #2e4995" id="modules"><a class="anchor" href="#modules"><img src="../assets/anchor.svg" alt></a>Modules</h3><p>Les Modules sont des scripts écrits en Python qui constituent les tâches. Une tâche appelle un module à l&#39;aide du YAML qui sera ensuite exécuté sur le serveur distant. Les modules permettent d&#39;uniformiser les actions à appliquer.</p>
</div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="configuration-de-ansible"><a class="anchor" href="#configuration-de-ansible"><img src="../assets/anchor.svg" alt></a>Configuration de Ansible</h2><p>Ansible peut être configuré à l&#39;aide de fichiers ou de variables d&#39;environnement système. La configuration suivra l&#39;ordre de priorités suivantes (la plus forte valeur en premier) :</p>
<ul>
<li>Variables d&#39;environnements</li>
<li>ansible.cfg (répertoire courant)</li>
<li>~/.ansible.cfg (utilisateur courant)</li>
<li>/etc/ansible/ansible.cfg</li>
</ul>
</div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-adhoc-commands"><a class="anchor" href="#ansible-adhoc-commands"><img src="../assets/anchor.svg" alt></a>Ansible AdHoc Commands</h2><p>Les commandes AdHoc sont lancées à la volée sans travail ni configuration préalable. Elles permettent de lancer des actions simples sur l&#39;ensemble des serveurs.
Il est nécessaire de lui passer en argument les serveurs (ou groupe de serveurs), le module à lancer (-m) et ses arguments (-a).</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible localhost -m ping
ansible localhost -m setup
ansible all -i inventories/servers -m ping</code></pre><p>Il est également possible de les joindre à des inventaires.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible all -i inventories/hosts -m debug -a &#x27;myVar&#x27;
ansible redhat -i inventories/hosts -m shell -a &#x27;uptime&#x27;</code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-inventories"><a class="anchor" href="#ansible-inventories"><img src="../assets/anchor.svg" alt></a>Ansible Inventories</h2><p>Les inventaires rassemblent les tâches et roles à appliquer sur des serveurs ou groupes de serveurs.
Ils sont généralement organisés par environnement pour utiliser toute la puissance des variables et notamment des group_vars.
Définition d&#39;un inventaire :</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-string">server.domain.fr</span>
<span class="hljs-string">server[01-09].domain.fr</span>

<span class="hljs-string">rhel01</span> <span class="hljs-string">rhel01.domain.fr</span>
<span class="hljs-string">deb01</span> <span class="hljs-string">deb01.domain.fr</span>
<span class="hljs-string">arch01</span> <span class="hljs-string">arch01.domain.fr</span>
<span class="hljs-string">win01</span> <span class="hljs-string">win01.domain.fr</span>

[<span class="hljs-string">redhat</span>]
<span class="hljs-string">rhel01</span>

[<span class="hljs-string">debian</span>]
<span class="hljs-string">deb01</span>

[<span class="hljs-string">linux:children</span>]
<span class="hljs-string">redhat</span>
<span class="hljs-string">debian</span>

[<span class="hljs-string">linux</span>]
<span class="hljs-string">arch01</span>

[<span class="hljs-string">windows</span>]
<span class="hljs-string">win01</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-tasks"><a class="anchor" href="#ansible-tasks"><img src="../assets/anchor.svg" alt></a>Ansible Tasks</h2><p>Une tâche Ansible est définie par une structure descriptive en YAML. L&#39;objet suivant liste les options d&#39;une tâche, seule l&#39;utilisation des modules est indispensable.</p>
<p>Définition de Task :</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">The</span> <span class="hljs-string">task</span> <span class="hljs-string">name</span> <span class="hljs-string">to</span> <span class="hljs-string">make</span> <span class="hljs-string">things</span> <span class="hljs-string">clearly</span>
  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span>
  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span>
  <span class="hljs-attr">become_user:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">check_mode:</span> <span class="hljs-literal">yes</span>
  <span class="hljs-attr">diff:</span> <span class="hljs-literal">no</span>
  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">ansible</span>
  <span class="hljs-attr">ignore_errors:</span> <span class="hljs-literal">True</span>
  <span class="hljs-attr">import_tasks:</span> <span class="hljs-string">more_handlers</span>
  <span class="hljs-attr">include_tasks:</span> <span class="hljs-string">other-tasks.yml</span>
  <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">apache</span>
  <span class="hljs-attr">register:</span> <span class="hljs-string">my_register</span>
  <span class="hljs-attr">changed_when:</span> <span class="hljs-literal">False</span>
  <span class="hljs-attr">failed_when:</span> <span class="hljs-literal">False</span>
  <span class="hljs-attr">vars:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">myvar:</span> <span class="hljs-string">toto</span>
    <span class="hljs-attr">myfiles:</span>
      <span class="hljs-bullet">-</span>  <span class="hljs-string">default.conf</span>
  <span class="hljs-attr">loop:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">item1</span>
    <span class="hljs-bullet">-</span> [<span class="hljs-string">&quot;item2&quot;</span>, <span class="hljs-string">&quot;item3&quot;</span>]
    <span class="hljs-bullet">-</span> { <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;item4&quot;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;Desc Item 4&quot;</span> }
  <span class="hljs-attr">when:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">my_register</span> <span class="hljs-string">is</span> <span class="hljs-string">defined</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;CentOS&quot;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span> 
  <span class="hljs-attr">block:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Task</span> <span class="hljs-string">to</span> <span class="hljs-string">run</span> <span class="hljs-string">in</span> <span class="hljs-string">block</span>
      <span class="hljs-string">...</span>
  <span class="hljs-attr">rescue:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Task</span> <span class="hljs-string">when</span> <span class="hljs-string">block</span> <span class="hljs-string">failed</span>
  <span class="hljs-attr">always:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Task</span> <span class="hljs-string">always</span> <span class="hljs-string">run</span> <span class="hljs-string">before/after</span> <span class="hljs-string">block</span>
  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">stuff</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-playbooks"><a class="anchor" href="#ansible-playbooks"><img src="../assets/anchor.svg" alt></a>Ansible Playbooks</h2><p>Un Playbook permet d&#39;appliquer des tâches sur les serveurs de l&#39;inventaire.</p>
<p><strong>Installer un paquet sur les serveurs Redhat</strong></p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> [<span class="hljs-string">redhat</span>]
  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span>
  <span class="hljs-string">tasks</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">yum:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span>
      <span class="hljs-attr">state:</span> <span class="hljs-string">installed</span></code></pre><p><strong>Lancer le rôle Docker sur les serveurs Docker excepté le Master</strong></p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">docker,!docker-master</span>
  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">roles:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">docker</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">kubernetes</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-variables"><a class="anchor" href="#ansible-variables"><img src="../assets/anchor.svg" alt></a>Ansible Variables</h2><h3 class="heading3" style="color: #2e4995" id="variable-definition"><a class="anchor" href="#variable-definition"><img src="../assets/anchor.svg" alt></a>Variable Definition</h3><p>Une variable Ansible peut être définie à plusieurs endroits, notamment dans les <em>group_vars</em>, <em>host_vars</em>, <em>role vars</em>, <em>CLI vars</em> et est appelée à l&#39;aide du Templating Jinja : <code class="codespan" style="color: #2e4995">{{ my_variable }}</code>. Les variables peuvent être appelées dans tous les objets Ansible (tasks, variables, template, ...).</p>
<h3 class="heading3" style="color: #2e4995" id="variable-typology"><a class="anchor" href="#variable-typology"><img src="../assets/anchor.svg" alt></a>Variable Typology</h3><p>Une variable est de 3 types (python) :</p>
<ul>
<li>String : chaîne de caractères,</li>
<li>Liste : Tableau d&#39;objets,</li>
<li>Dictionnaire : Tableau associatif d&#39;objets.</li>
</ul>
<p>Une variable est définie par un couple Clé/Valeur où la Clé est normalisée ([a-z][A-Z][0-9][_-]) et la Valeur est une structure comme définie ci-dessus.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-attr">my_string:</span> <span class="hljs-string">&quot;value&quot;</span>
<span class="hljs-attr">my_list:</span> [<span class="hljs-string">&quot;bob&quot;</span>, <span class="hljs-string">&quot;alice&quot;</span>]
<span class="hljs-attr">my_list:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;bob&quot;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;alice&quot;</span>
<span class="hljs-attr">my_dict:</span>
    <span class="hljs-attr">item1:</span> <span class="hljs-string">value1</span>
    <span class="hljs-attr">item2:</span> <span class="hljs-string">value2</span></code></pre><h3 class="heading3" style="color: #2e4995" id="variable-precedence"><a class="anchor" href="#variable-precedence"><img src="../assets/anchor.svg" alt></a>Variable precedence</h3><p>Les variables Ansible peuvent être définies à plusieurs endroits comme <code class="codespan" style="color: #2e4995">group_vars</code>, <code class="codespan" style="color: #2e4995">playbooks</code>, <code class="codespan" style="color: #2e4995">roles</code>, etc... et sont évaluées par priorité. Voici la liste des priorités en commençant par la plus faible :</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">Valeur en ligne de commande
Valeur par default du rôle
Fichier d&#x27;inventaire
Inventaire global group_vars/all
Playook group_vars/all
Inventaires group_vars/*
Playbook group_vars/*
Fichier d&#x27;inventaire ou script host vars
Inventaire host_vars/*
Playbook host_vars/*
Facts serveur / set_facts en cache
Variables du Play
Variables vars_prompt du Play
Variables vars_files du Play
Variables du rôle (dans role/vars/main.yml)
Bloc de variables (seulement pour les blocs de tâches)
Variables des tâches (seulement pour les tâches)
Import de variables include_vars
Facts set_facts / Variables register
Paramètres de rôle and inclusion include_role
Import des paramètres
Extra vars argument des CLI (-e)</code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-plays"><a class="anchor" href="#ansible-plays"><img src="../assets/anchor.svg" alt></a>Ansible Plays</h2><p>Une liste conséquente d&#39;attributs d&#39;un Play Ansible au sein d&#39;un Playbook :</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span>
  <span class="hljs-attr">accelerate:</span> <span class="hljs-literal">no</span>
  <span class="hljs-attr">accelerate_port:</span> <span class="hljs-number">5099</span>
  <span class="hljs-attr">ansible_connection:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">any_errors_fatal:</span> <span class="hljs-literal">True</span>
  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span>
  <span class="hljs-attr">become_method:</span> <span class="hljs-string">su</span>
  <span class="hljs-attr">become_user:</span> <span class="hljs-string">postgress</span>
  <span class="hljs-attr">become_flags:</span> <span class="hljs-literal">True</span>
  <span class="hljs-attr">debugger:</span> <span class="hljs-string">on_failed</span>
  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span>
  <span class="hljs-attr">max_fail_percentage:</span> <span class="hljs-number">30</span>
  <span class="hljs-attr">order:</span> <span class="hljs-string">sorted</span>
  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">serial:</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">strategy:</span> <span class="hljs-string">debug</span>
  <span class="hljs-attr">vars:</span>
    <span class="hljs-attr">http_port:</span> <span class="hljs-number">80</span>
  <span class="hljs-attr">vars_files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;vars.yml&quot;</span>
  <span class="hljs-attr">vars_prompt:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;my_password2&quot;</span>
      <span class="hljs-attr">prompt:</span> <span class="hljs-string">&quot;Enter password2&quot;</span>
      <span class="hljs-attr">default:</span> <span class="hljs-string">&quot;secret&quot;</span>
      <span class="hljs-attr">private:</span> <span class="hljs-literal">yes</span>
      <span class="hljs-attr">encrypt:</span> <span class="hljs-string">&quot;md5_crypt&quot;</span>
      <span class="hljs-attr">confirm:</span> <span class="hljs-literal">yes</span>
      <span class="hljs-attr">salt:</span> <span class="hljs-number">1234</span>
      <span class="hljs-attr">salt_size:</span> <span class="hljs-number">8</span>
  <span class="hljs-attr">tags:</span> 
    <span class="hljs-bullet">-</span> <span class="hljs-string">stuff</span>
  <span class="hljs-attr">pre_tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;task&gt;</span>
  <span class="hljs-attr">roles:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">common</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">common</span>
      <span class="hljs-attr">vars:</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">5000</span>
      <span class="hljs-attr">when:</span> <span class="hljs-string">&quot;bar == &#x27;Baz&#x27;&quot;</span>
      <span class="hljs-attr">tags :</span> [<span class="hljs-string">one</span>, <span class="hljs-string">two</span>]
    <span class="hljs-bullet">-</span> <span class="hljs-string">common</span>
    <span class="hljs-bullet">-</span> { <span class="hljs-attr">role:</span> <span class="hljs-string">common</span>, <span class="hljs-attr">port:</span> <span class="hljs-number">5000</span>, <span class="hljs-attr">when:</span> <span class="hljs-string">&quot;bar == &#x27;Baz&#x27;&quot;</span>, <span class="hljs-string">tags</span> <span class="hljs-string">:</span>[<span class="hljs-string">one</span>, <span class="hljs-string">two</span>] }
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">tasks.yaml</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">tasks.yaml</span>
      <span class="hljs-attr">when:</span> <span class="hljs-string">day</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;Thursday&#x27;</span>
      <span class="hljs-attr">vars:</span>
        <span class="hljs-attr">foo:</span> <span class="hljs-string">aaa</span> 
        <span class="hljs-attr">baz:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">z</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">y</span>
    <span class="hljs-bullet">-</span> { <span class="hljs-attr">include:</span> <span class="hljs-string">tasks.yaml</span>, <span class="hljs-attr">foo:</span> <span class="hljs-string">zzz</span>, <span class="hljs-attr">baz:</span> [<span class="hljs-string">a</span>,<span class="hljs-string">b</span>]}
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;task&gt;</span>
  <span class="hljs-attr">post_tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;task&gt;</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-roles"><a class="anchor" href="#ansible-roles"><img src="../assets/anchor.svg" alt></a>Ansible Roles</h2><h3 class="heading3" style="color: #2e4995" id="structure-of-a-role"><a class="anchor" href="#structure-of-a-role"><img src="../assets/anchor.svg" alt></a>Structure of a role</h3><p>Arboresence de répertoire d&#39;un rôle Ansible :</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">roles/
└── my-role
    ├── defaults
    │   └── main.yml
    ├── files
    |   └── file
    ├── handlers
    │   └── main.yml
    ├── tasks
    │   └── main.yml
    ├── templates
    |   └── template.j2
    └── vars
        └── main.yml</code></pre><p>Liste des fichiers potentiels et leurs fonctions au sein du rôle :</p>
<ul>
<li><code class="codespan" style="color: #2e4995">my-role/defaults/main.yml</code> définit les variables par défaut du rôle,</li>
<li><code class="codespan" style="color: #2e4995">my-role/files/file</code> est un fichier (sans variables Jinja) à copier sur le serveur distant,</li>
<li><code class="codespan" style="color: #2e4995">my-role/handlers/main.yml</code> définit les Handlers déclenchables,</li>
<li><code class="codespan" style="color: #2e4995">my-role/tasks/main.yml</code> est le fichier de tâches par défaut appelé à l&#39;appel du rôle,</li>
<li><code class="codespan" style="color: #2e4995">my-role/templates/template.yml.j2</code> est un fichier (avec variables Jinja) à copier,</li>
<li><code class="codespan" style="color: #2e4995">my-role/vars/main.yml</code> définit les variables à surcharger.</li>
</ul>
<h4 class="heading4" style="color: #2e4995" id="génération-et-copie-dun-template"><a class="anchor" href="#génération-et-copie-dun-template"><img src="../assets/anchor.svg" alt></a>Génération et copie d&#39;un Template</h4><p>Fichier Template <code class="codespan" style="color: #2e4995">roles/example/templates/my-template.sh.j2</code></p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;{{ timezone }}&quot;</span></code></pre><p>Fichier Task <code class="codespan" style="color: #2e4995">roles/example/tasks/main.yml</code></p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">template:</span>
    <span class="hljs-attr">src:</span> <span class="hljs-string">my-template.sh.j2</span>
    <span class="hljs-attr">dest:</span> <span class="hljs-string">/tmp/my-template.sh</span></code></pre><h4 class="heading4" style="color: #2e4995" id="déclenchement-dun-handler"><a class="anchor" href="#déclenchement-dun-handler"><img src="../assets/anchor.svg" alt></a>Déclenchement d&#39;un Handler</h4><p>Fichier Handler <code class="codespan" style="color: #2e4995">roles/example/handlers/main.yml</code>.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Apache</span>
  <span class="hljs-attr">systemd:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span>
    <span class="hljs-attr">state:</span> <span class="hljs-string">restart</span></code></pre><p>Fichier Task <code class="codespan" style="color: #2e4995">roles/example/tasks/main.yml</code>.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">copy:</span>
    <span class="hljs-attr">src:</span> <span class="hljs-string">httpd.conf</span>
    <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/httpd/conf/httpd.conf</span>
  <span class="hljs-attr">notify:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Apache</span></code></pre><p>Le Handler <code class="codespan" style="color: #2e4995">Restart Apache</code> sera déclenché à l&#39;exécution de la Task <code class="codespan" style="color: #2e4995">copy</code> (état <em>changed</em>).</p>
<h4 class="heading4" style="color: #2e4995" id="variables-par-défaut-du-rôle"><a class="anchor" href="#variables-par-défaut-du-rôle"><img src="../assets/anchor.svg" alt></a>Variables par défaut du rôle</h4><p>Ficheir Variables <code class="codespan" style="color: #2e4995">roles/example/defaults/main.yml</code></p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-attr">apache_version:</span> <span class="hljs-string">&#x27;2.4.2&#x27;</span></code></pre><p>Fichier Task <code class="codespan" style="color: #2e4995">roles/example/tasks/main.yml</code></p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">yum:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">httpd-{{</span> <span class="hljs-string">apache_version</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="import-de-playbooks-tasks-et-roles"><a class="anchor" href="#import-de-playbooks-tasks-et-roles"><img src="../assets/anchor.svg" alt></a>Import de Playbooks, Tasks et Roles</h2><h3 class="heading3" style="color: #2e4995" id="inclusion-dun-playbook"><a class="anchor" href="#inclusion-dun-playbook"><img src="../assets/anchor.svg" alt></a>Inclusion d&#39;un playbook</h3><p>Seul l&#39;appel <code class="codespan" style="color: #2e4995">import_playbook</code> permet d&#39;inclure un Playbook entier dans un autre.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">import_playbook:</span> <span class="hljs-string">install_apache.yml</span></code></pre><h3 class="heading3" style="color: #2e4995" id="inclusion-de-tâches"><a class="anchor" href="#inclusion-de-tâches"><img src="../assets/anchor.svg" alt></a>Inclusion de tâches</h3><p>Les appels <code class="codespan" style="color: #2e4995">import_task</code> et <code class="codespan" style="color: #2e4995">include_task</code> permettent d&#39;inclure des tâches.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> [<span class="hljs-string">redhat</span>]
  <span class="hljs-attr">tasks:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">import_tasks:</span> <span class="hljs-string">roles/example/tasks/main.yml</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">include_tasks:</span> <span class="hljs-string">roles/example/tasks/main.yml</span></code></pre><p>Les 2 méthodes ont des particularités.</p>
<h3 class="heading3" style="color: #2e4995" id="inclusion-de-tâches-en-filtrant-par-tag"><a class="anchor" href="#inclusion-de-tâches-en-filtrant-par-tag"><img src="../assets/anchor.svg" alt></a>Inclusion de tâches en filtrant par tag</h3><p>Seul l&#39;appel <code class="codespan" style="color: #2e4995">import_tasks</code> permet d&#39;inclure des tâches et de les filtrer à l&#39;aide de Tags. <strong>Important</strong> : Les appels <code class="codespan" style="color: #2e4995">include_tasks</code> nécessitent de comporter les tags à propager, sinon les tâches ne s&#39;exécuteront pas.</p>
<h3 class="heading3" style="color: #2e4995" id="inclusion-dun-rôle"><a class="anchor" href="#inclusion-dun-rôle"><img src="../assets/anchor.svg" alt></a>Inclusion d&#39;un rôle</h3><p>Les appels <code class="codespan" style="color: #2e4995">import_role</code> et <code class="codespan" style="color: #2e4995">include_role</code> permettent d&#39;inclure des tâches d&#39;un rôle.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> [<span class="hljs-string">redhat</span>]
  <span class="hljs-attr">tasks:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">import_role:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">example</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">include_role:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">example</span></code></pre><h3 class="heading3" style="color: #2e4995" id="inclusion-dune-partie-dun-rôle"><a class="anchor" href="#inclusion-dune-partie-dun-rôle"><img src="../assets/anchor.svg" alt></a>Inclusion d&#39;une partie d&#39;un rôle</h3><p>L&#39;appel <code class="codespan" style="color: #2e4995">include_role</code> permet d&#39;inclure une partie d&#39;un rôle en embarquant son écosystème : variables, handlers. L&#39;attribut <code class="codespan" style="color: #2e4995">tasks_from</code> permet de cibler le fichier de tâches à appeler à la place du <code class="codespan" style="color: #2e4995">main.yml</code>. Il devient facile de personnaliser les rôles et leur donner plusieurs sens fonctionnels.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> [<span class="hljs-string">redhat</span>]
  <span class="hljs-attr">tasks:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">include_role:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">example</span>
      <span class="hljs-attr">tasks_from:</span> <span class="hljs-string">install</span></code></pre><p>Ceci appelle le rôle <code class="codespan" style="color: #2e4995">example</code> au travers du fichier de tâche <code class="codespan" style="color: #2e4995">install.yml</code> inclus dans le rôle.</p>
<h3 class="heading3" style="color: #2e4995" id="inclusion-de-rôle-en-filtrant-par-tag"><a class="anchor" href="#inclusion-de-rôle-en-filtrant-par-tag"><img src="../assets/anchor.svg" alt></a>Inclusion de rôle en filtrant par tag</h3><p>Seul l&#39;appel <code class="codespan" style="color: #2e4995">import_role</code> permet d&#39;inclure un rôle tout en posant un filtre avec des tags. <strong>Important</strong> : Les appels <code class="codespan" style="color: #2e4995">include_role</code> nécessitent de comporter les tags à propager, sinon les tâches ne s&#39;exécuteront pas.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> [<span class="hljs-string">redhat</span>]
  <span class="hljs-attr">tasks:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">import_role:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">example</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-options"><a class="anchor" href="#ansible-options"><img src="../assets/anchor.svg" alt></a>Ansible Options</h2><p>Ansible offre des possibilités plus avancées qui aident à la vérification, au débuggage et poussent sur le plan non destructif des exécutions.</p>
<h3 class="heading3" style="color: #2e4995" id="filtre-sur-linventaire"><a class="anchor" href="#filtre-sur-linventaire"><img src="../assets/anchor.svg" alt></a>Filtre sur l&#39;inventaire</h3><p>L&#39;option <code class="codespan" style="color: #2e4995">--limit</code> ou <code class="codespan" style="color: #2e4995">-l</code> filtre l&#39;exécution du Playbook par serveur (host ou alias), groupe de l&#39;inventaire et interpête parfaitement les exclusions.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-playbook -i hosts.yml playbook.yml --limit &#x27;linux,!debian&#x27;</code></pre><h3 class="heading3" style="color: #2e4995" id="filtre-par-tag"><a class="anchor" href="#filtre-par-tag"><img src="../assets/anchor.svg" alt></a>Filtre par Tag</h3><p>L&#39;option <code class="codespan" style="color: #2e4995">--tag</code> ou <code class="codespan" style="color: #2e4995">-t</code> filtre l&#39;exécution du Playbook par tag stipulés dans l&#39;attribut <code class="codespan" style="color: #2e4995">tags:</code> des Plays et Tasks. L&#39;exclusion est possible sur le filtre par Tag.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-playbook -i host.yml playbook.yml --tags &#x27;config,service&#x27; --skip-tags &#x27;reload&#x27;</code></pre><h3 class="heading3" style="color: #2e4995" id="mode-dry-run"><a class="anchor" href="#mode-dry-run"><img src="../assets/anchor.svg" alt></a>Mode Dry-Run</h3><p>L&#39;option <code class="codespan" style="color: #2e4995">--check</code> déroule le Playbook sans effectuer la modification côté serveur et projette l&#39;état de l&#39;action (<em>ok</em>, <em>changed</em>, <em>failed</em>). Le mode Dry-Run est un bon moyen de tester la robustesse des scripts Ansible.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-playbook -i host.yml playbook.yml --check</code></pre><p>L&#39;option Dry-Run fausse l&#39;idempotence avec les modules shell et commands à cause du manque de visiblité d&#39;Ansible vis-à-vis des commandes shell du script.</p>
<h3 class="heading3" style="color: #2e4995" id="mode-différences"><a class="anchor" href="#mode-différences"><img src="../assets/anchor.svg" alt></a>Mode Différences</h3><p>L&#39;option <code class="codespan" style="color: #2e4995">--diff</code> affiche les différences constatées sur les actions liées aux fichiers (copy, template). Le mode des différences est une pratique utile pour constater les changements opérés sur les serveurs.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-playbook -i host.yml playbook.yml --diff</code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-modules"><a class="anchor" href="#ansible-modules"><img src="../assets/anchor.svg" alt></a>Ansible Modules</h2><h3 class="heading3" style="color: #2e4995" id="emplacement"><a class="anchor" href="#emplacement"><img src="../assets/anchor.svg" alt></a>Emplacement</h3><p>Le module peut être stocké à plusieurs endroits :</p>
<ul>
<li>En local (répertoire courant) : Créer le Module Ansible où sont lancés les Playbooks dans le répertoire <code class="codespan" style="color: #2e4995">library</code>.</li>
<li>Coté Serveur (tous les utilisateurs) : Définir le chemin des modules dans l&#39;attriubt <code class="codespan" style="color: #2e4995">library</code> du fichier <code class="codespan" style="color: #2e4995">ansible.cfg</code>.<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-attr">library</span> = /usr/share/my_modules/</code></pre></li>
</ul>
<h3 class="heading3" style="color: #2e4995" id="instanciation-de-la-classe-du-module"><a class="anchor" href="#instanciation-de-la-classe-du-module"><img src="../assets/anchor.svg" alt></a>Instanciation de la Classe du Module</h3><p>Le module à appeler correspond au nom du fichier du Module : <code class="codespan" style="color: #2e4995">./library/myansiblemodule.py</code>.
La Classe du Module doit à minima comporter un constructeur et une méthode d&#39;appel, ici <code class="codespan" style="color: #2e4995">def process()</code>.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAnsibleModule</span>(<span class="hljs-params">AnsibleModule</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        self._output = []
        self._facts = <span class="hljs-built_in">dict</span>()
        <span class="hljs-built_in">super</span>(MyAnsibleModule, self).__init__(*args, **kwargs)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self</span>):</span>
        [...]</code></pre><h3 class="heading3" style="color: #2e4995" id="exécution-du-module"><a class="anchor" href="#exécution-du-module"><img src="../assets/anchor.svg" alt></a>Exécution du module</h3><pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
  MyAnsibleModule().process()</code></pre><h3 class="heading3" style="color: #2e4995" id="définition-des-attributs"><a class="anchor" href="#définition-des-attributs"><img src="../assets/anchor.svg" alt></a>Définition des attributs</h3><p>La définition des arguments du module se fait grâce à l&#39;option <code class="codespan" style="color: #2e4995">argument_spec</code> de la Classe. L&#39;objet passé dans l&#39;attribut doit être un dictionnaire.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">MyAnsibleModule(
    argument_spec=<span class="hljs-built_in">dict</span>(
        url=<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;str&#x27;</span>,
                 required=<span class="hljs-literal">True</span>),
        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;str&#x27;</span>,
                  required=<span class="hljs-literal">True</span>,
                  choices=[<span class="hljs-string">&#x27;indice&#x27;</span>, <span class="hljs-string">&#x27;document&#x27;</span>]),
        state=<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;str&#x27;</span>,
                   choices=[<span class="hljs-string">&#x27;present&#x27;</span>,<span class="hljs-string">&#x27;absent&#x27;</span>],
                   default=<span class="hljs-string">&#x27;present&#x27;</span>)
    )
).process()</code></pre><p>L&#39;intéraction avec les arguments dans la méthode d&#39;appel se fait avec la variable <code class="codespan" style="color: #2e4995">self.params</code>.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self</span>):</span>
    <span class="hljs-keyword">try</span>:
        changed = <span class="hljs-literal">False</span>

        <span class="hljs-comment"># Retrieve value for attribute &#x27;url&#x27;</span>
        param_url = self.params[<span class="hljs-string">&#x27;url&#x27;</span>]

        self.exit_json(changed=changed, ansible_facts={}, output=self._output)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        self.fail_json(msg=(e.message, self._output))</code></pre><h3 class="heading3" style="color: #2e4995" id="activation-du-mode-dry-run"><a class="anchor" href="#activation-du-mode-dry-run"><img src="../assets/anchor.svg" alt></a>Activation du mode Dry-Run</h3><p>Pour utiliser le mode Dry-Run, il faut activer l&#39;option <code class="codespan" style="color: #2e4995">supports_check_mode</code> dans la Classe.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    MyAnsibleModule(
        supports_check_mode=<span class="hljs-literal">True</span>,
        [...]
    ).process()</code></pre><p>L&#39;intéraction avec le mode Dry-Run dans la méthode se fait avec la variable <code class="codespan" style="color: #2e4995">self.check_mode</code>.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self</span>):</span>
    <span class="hljs-comment"># Stop if check_mode is true before doing any action</span>
    <span class="hljs-keyword">if</span> self.check_mode:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-comment"># Keep doing actions if check_mode is false</span></code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="ansible-vault"><a class="anchor" href="#ansible-vault"><img src="../assets/anchor.svg" alt></a>Ansible Vault</h2><h3 class="heading3" style="color: #2e4995" id="vault-configuration"><a class="anchor" href="#vault-configuration"><img src="../assets/anchor.svg" alt></a>Vault Configuration</h3><p>La configuration du mot de passe dans Ansible Vault se fait sous plusieurs angles :</p>
<ul>
<li>Attribut <code class="codespan" style="color: #2e4995">vault_password_file</code> dans le fichier <code class="codespan" style="color: #2e4995">ansible.cfg</code>,</li>
<li>Variable environnement <code class="codespan" style="color: #2e4995">ANSIBLE_VAULT_PASSWORD_FILE</code>,</li>
<li>Argument de commande <code class="codespan" style="color: #2e4995">--vault-password-file</code> ou <code class="codespan" style="color: #2e4995">--vault-id</code> avec le fichier contenant le mot de passe,</li>
<li>Argument de commande <code class="codespan" style="color: #2e4995">--ask-vault-pass</code> pour demander le mot de passe.</li>
</ul>
<h3 class="heading3" style="color: #2e4995" id="vault-fichier"><a class="anchor" href="#vault-fichier"><img src="../assets/anchor.svg" alt></a>Vault Fichier</h3><p>Un fichier peut être encrypté complètement.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-vault create foo.yml
ansible-vault encrypt foo.yml</code></pre><p>Une fois encrypté, il est possible de le lire ou le décrypter.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-vault view foo.yml
ansible-vault decrypt foo.yml</code></pre><h3 class="heading3" style="color: #2e4995" id="vault-variables"><a class="anchor" href="#vault-variables"><img src="../assets/anchor.svg" alt></a>Vault Variables</h3><p>Une variable peut être encryptée, au lieu du fichier, pour faciliter l&#39;accès au fichier en clair sans dévoiler les valeurs sensibles.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-vault encrypt_string --name &#x27;mykey&#x27; &#x27;mysecret&#x27;</code></pre><h3 class="heading3" style="color: #2e4995" id="ansible-avec-vault"><a class="anchor" href="#ansible-avec-vault"><img src="../assets/anchor.svg" alt></a>Ansible avec Vault</h3><p>La configuration du mot de passe dans le système est importante pour utiliser Ansible le stipuler à chaque commande.</p>
<p>Si ce n&#39;est pas le cas, il est nécessaire de l&#39;inclure dans la commande.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-playbook site.yml --ask-vault-pass
ansible-playbook site.yml --vault-password-file ~/.vault_pass
ansible-playbook --vault-id dev@dfile-dev-password site.yml
ansible-playbook --vault-id prod@prompt site.yml</code></pre><p>Il est également possible de fournir plusieurs mots de passe pour dérouler les actions sur plusieurs environnements sans changer la commande entre les plateformes.</p>
<pre style="background-color: #fef2e1"><code class="code" style="color: #2e2b77">ansible-playbook --vault-id dev@dev-password --vault-id prod@prompt site.yml</code></pre></div>
                        <div class="h2-part">
                            <h2 class="heading2" style="color: #2e4995" id="extension-par-utilisation"><a class="anchor" href="#extension-par-utilisation"><img src="../assets/anchor.svg" alt></a>Extension par utilisation</h2><p>Ansible est en premier lieu un outil de déploiement permettant d&#39;homogénéiser les actions coté serveur et de centraliser la configuration des applications déployées.</p>
<h3 class="heading3" style="color: #2e4995" id="vérifications"><a class="anchor" href="#vérifications"><img src="../assets/anchor.svg" alt></a>Vérifications</h3><p>Ansible peut cependant être utilisé pour une toute autre utilisation.
L&#39;implémentation du mode Dry-Run permet de vérifier l&#39;état des serveurs sans apporter de modifications.
Il devient facile de l&#39;utiliser comme outil de vérification dans le but de contrôler tout changement opéré sur les serveurs.</p>
<h3 class="heading3" style="color: #2e4995" id="idempotence"><a class="anchor" href="#idempotence"><img src="../assets/anchor.svg" alt></a>Idempotence</h3><p>L&#39;idempotence est la facultée d&#39;une action à ne pas appliquer de changement quand il n&#39;est pas nécessaire.
La répétabilité de l&#39;action ne doit pas être destructrice (état <em>changed</em>) et doit remonter quant à sa bonne configuration (état <em>ok</em>).</p>
<p>Un playbook est idempotent dès lors qu&#39;il ne provoque plus d&#39;état <em>changed</em> à son passage. L&#39;idempotence est dite parfaite quand, à un instant t, les actions sont changeantes sur le premier lancement et ne le sont plus sur tous les suivants.</p>

        </div>
    </body>
</html>
